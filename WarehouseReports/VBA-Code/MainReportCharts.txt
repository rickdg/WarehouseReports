Private Sub Worksheet_Activate()
    If Cells(1, 100).Value2 = 1 Then Exit Sub

    Application.ScreenUpdating = False
    ActiveWindow.DisplayGridlines = False

    Range("E1:F1").Value2 = array("% отбора", "Разница")
    
    With Range("A1:F1")
        .HorizontalAlignment = xlCenter
        .Font.Bold = True
    End With
    
    Set LastCell = Range("A:A").Find(What:="*", SearchDirection:=xlPrevious, SearchOrder:=xlByRows)
    
    For r = 2 To LastCell.Row
        Cells(r, 5).FormulaR1C1 = "=RC3/SUM(C3)"
        Cells(r, 6).FormulaR1C1 = "=RC5-RC4"
        GetRange(r, 1, r, 6).Interior.Color = GetColor(Cells(r, 1).Value2)
    Next
    
    Columns("E:E").Style = "Percent"
    
    Set targetRange = GetRange(1, 1, LastCell.Row, 6)
   
    With targetRange
        .Borders(xlEdgeLeft).LineStyle = xlContinuous
        .Borders(xlEdgeTop).LineStyle = xlContinuous
        .Borders(xlEdgeBottom).LineStyle = xlContinuous
        .Borders(xlEdgeRight).LineStyle = xlContinuous
        .Borders(xlInsideVertical).LineStyle = xlContinuous
        .Borders(xlInsideHorizontal).LineStyle = xlContinuous
    End With
    
    Cells(1, 100).Value2 = 1

    Application.ScreenUpdating = True
End Sub


Private Function GetRange(ByVal r1 As Integer, ByVal c1 As Integer, ByVal r2 As Integer, ByVal c2 As Integer) As Range
    Set GetRange = Range(Cells(r1, c1), Cells(r2, c2))
End Function


Private Function GetColor(value As Integer) As Variant
    Select Case value
        Case 100
            GetColor = rgb(128, 203, 196)
        Case 200
            GetColor = rgb(129, 212, 250)
        Case 300
            GetColor = rgb(255, 204, 128)
        Case 500
            GetColor = rgb(239, 154, 154)
    End Select
End Function