Private Sub Worksheet_Activate()
    If Cells(1, 100).Value2 = 1 Then Exit Sub

    Application.ScreenUpdating = False

    Range("E1:F1").Value2 = array("% отбора", "Разница")
    
    With Range("A1:F1")
        .HorizontalAlignment = xlCenter
        .Font.Bold = True
    End With
    
    Set LastCell = Range("A:A").Find(What:="*", SearchDirection:=xlPrevious, SearchOrder:=xlByRows)
    
    For r = 2 To LastCell.Row
        Cells(r, 5).FormulaR1C1 = "=RC3/SUM(C3)"
        
        Cells(r, 6).FormulaR1C1 = "=RC5-RC4"
        Range(Cells(r, 1), Cells(r, 6)).Interior.Color = GetColor(Cells(r, 1).Value2)
    Next
    
    Set TargetRange = Range(Cells(2, 6), Cells(LastCell.Row, 6))
    TargetRange.FormatConditions.Add Type:=xlCellValue, Operator:=xlLess, Formula1:="=0"
    With TargetRange.FormatConditions(1)
        .Font.Bold = True
        .Font.Color = -16776961
        .StopIfTrue = False
    End With
    
    Columns("E:E").Style = "Percent"
    
    Set TargetRange = Range(Cells(1, 1), Cells(LastCell.Row, 6))
   
    With TargetRange
        .Borders(xlEdgeLeft).LineStyle = xlContinuous
        .Borders(xlEdgeTop).LineStyle = xlContinuous
        .Borders(xlEdgeBottom).LineStyle = xlContinuous
        .Borders(xlEdgeRight).LineStyle = xlContinuous
        .Borders(xlInsideVertical).LineStyle = xlContinuous
        .Borders(xlInsideHorizontal).LineStyle = xlContinuous
    End With
    
    Cells(1, 100).Value2 = 1

    Application.ScreenUpdating = True
End Sub


Private Function GetColor(value As Integer) As Variant
    Select Case value
        Case 100
            GetColor = RGB(192, 216, 238)
        Case 200
            GetColor = RGB(248, 205, 176)
        Case 300
            GetColor = RGB(220, 220, 220)
        Case 500
            GetColor = RGB(255, 231, 157)
    End Select
End Function